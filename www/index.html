<!doctype html>
<html>

<head>
<meta charset="utf-8">
<script type="text/javascript" src="runtime.js"></script>
<script type="text/javascript" src="stdlib.min.js"></script>
<script type="text/javascript" src="dial.js"></script>
<style>
  font-family: monospace;
</style>
</head>

<body onload="brython({debug: 1})">

<a href="/check.html">Jump to tests</a>
<br />

<textarea cols="55" rows="40" id="source">
diagram: HTTPLoad
version: 1.0
author: Vahid Mardani

sequence: Event Loop

cli -> httpd: err_t start(httpd*)
  for: i in range(forks)
    httpd -> ev: server_start(evs*)
      ev -> tcp: int listen(port)
      ev -> ev_epoll: err_t server_init(evs*)
      ev -> ev_common: err_t fork(evs*, epoll_loop)
      if: err
        ev -> ev_epoll: server_deinit(evs*)
        @over: Error
      else: ok
        @over: Ok
cli -> httpd: err_t join(httpd*)
</textarea>
<textarea cols="55" rows="40" id="target"></textarea>
<textarea cols="55" rows="40" id="error"></textarea>

<script type="text/python">
from browser import document, bind

from dial import Diagram, InterpreterError

source = document['source']
target = document['target']
error = document['error']
processing = False


def update(e):
  global processing
  if processing:
    return

  if hasattr(e, 'charCode') and e.charCode != 13:
    return 

  processing = True
  print('processing')
  try:
    error.value = ''
    v = source.value
    d = Diagram(v)
    target.value = d.dumps()
  except InterpreterError as ex:
    error.value = str(ex)
    print('error')
  finally:
    processing = False


source.bind('keypress', update)
source.bind('change', update)
update(None)

# pythonpath: ['public']
</script>
</body>

</html>
