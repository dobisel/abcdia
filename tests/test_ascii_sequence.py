from dial.ascii import ASCIIDiagramRenderer
from dial.diagram import Diagram

from .helpers import eqdia


def test_asciisequence_header():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence: Bar
    '''))
    assert eqdia(str(r.render()), '''
    .................
    . DIAGRAM: Foo  .
    . version: 1.0  .
    .               .
    . SEQUENCE: Bar .
    .               .
    .................
    ''')

    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:
    '''))
    assert eqdia(str(r.render()), '''
    ................
    . DIAGRAM: Foo .
    . version: 1.0 .
    .              .
    ................
    ''')


def test_asciisequence_callstack():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        foo.title: Foo
        foo -> bar
          bar -> thud
            thud -> qux
              qux -> quux
        foo -> qux
        foo -> quux
          quux -> qux
    '''))
    assert eqdia(str(r.render()), '''
    ...............................................
    . DIAGRAM: Foo                                .
    . version: 1.0                                .
    .                                             .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    . | Foo | | bar | | thud  | | qux | | quux  | .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    .    |       |        |        |        |     .
    .    |~~~~~~>|        |        |        |     .
    .    |       |~~~~~~~>|        |        |     .
    .    |       |        |~~~~~~~>|        |     .
    .    |       |        |        |~~~~~~~>|     .
    .    |       |        |        |        |     .
    .    |       |        |        |<-------|     .
    .    |       |        |<-------|        |     .
    .    |       |<-------|        |        |     .
    .    |<------|        |        |        |     .
    .    |       |        |        |        |     .
    .    |~~~~~~~~~~~~~~~~~~~~~~~~>|        |     .
    .    |       |        |        |        |     .
    .    |<------------------------|        |     .
    .    |       |        |        |        |     .
    .    |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~>|     .
    .    |       |        |        |        |     .
    .    |       |        |        |<~~~~~~~|     .
    .    |       |        |        |        |     .
    .    |       |        |        |------->|     .
    .    |       |        |        |        |     .
    .    |<---------------------------------|     .
    .    |       |        |        |        |     .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    . | Foo | | bar | | thud  | | qux | | quux  | .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    .                                             .
    ...............................................
    ''')


def test_asciisequence_call_notext():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b
        foo -> bar
        foo -> b
        f -> bar
    '''))
    assert eqdia(str(r.render()), '''
    ...............................
    . DIAGRAM: Foo                .
    . version: 1.0                .
    .                             .
    . +---+ +---+ +-----+ +-----+ .
    . | f | | b | | foo | | bar | .
    . +---+ +---+ +-----+ +-----+ .
    .   |     |      |       |    .
    .   |~~~~>|      |       |    .
    .   |     |      |       |    .
    .   |<----|      |       |    .
    .   |     |      |       |    .
    .   |     |      |~~~~~~>|    .
    .   |     |      |       |    .
    .   |     |      |<------|    .
    .   |     |      |       |    .
    .   |     |<~~~~~|       |    .
    .   |     |      |       |    .
    .   |     |----->|       |    .
    .   |     |      |       |    .
    .   |~~~~~~~~~~~~~~~~~~~>|    .
    .   |     |      |       |    .
    .   |<-------------------|    .
    .   |     |      |       |    .
    . +---+ +---+ +-----+ +-----+ .
    . | f | | b | | foo | | bar | .
    . +---+ +---+ +-----+ +-----+ .
    .                             .
    ...............................
    ''')


def test_asciisequence_calltext_minimum():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b: 1
        foo -> bar: 2
        foo -> b: 3
        f -> bar: 4
    '''))
    assert eqdia(str(r.render()), '''
    ................................
    . DIAGRAM: Foo                 .
    . version: 1.0                 .
    .                              .
    . +---+  +---+ +-----+ +-----+ .
    . | f |  | b | | foo | | bar | .
    . +---+  +---+ +-----+ +-----+ .
    .   |      |      |       |    .
    .   |~~1~~>|      |       |    .
    .   |      |      |       |    .
    .   |<-----|      |       |    .
    .   |      |      |       |    .
    .   |      |      |~~~2~~>|    .
    .   |      |      |       |    .
    .   |      |      |<------|    .
    .   |      |      |       |    .
    .   |      |<~~3~~|       |    .
    .   |      |      |       |    .
    .   |      |----->|       |    .
    .   |      |      |       |    .
    .   |~~~~~~~~~~4~~~~~~~~~>|    .
    .   |      |      |       |    .
    .   |<--------------------|    .
    .   |      |      |       |    .
    . +---+  +---+ +-----+ +-----+ .
    . | f |  | b | | foo | | bar | .
    . +---+  +---+ +-----+ +-----+ .
    .                              .
    ................................
    ''')


def test_asciisequence_calltext():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b: init()
        foo -> bar: init()
        foo -> b: init()
        f -> bar: 010101010101010101010101010101010101
    '''))
    assert eqdia(str(r.render()), '''
    ....................................................
    . DIAGRAM: Foo                                     .
    . version: 1.0                                     .
    .                                                  .
    . +---+       +---+      +-----+           +-----+ .
    . | f |       | b |      | foo |           | bar | .
    . +---+       +---+      +-----+           +-----+ .
    .   |           |           |                 |    .
    .   |~~init()~~>|           |                 |    .
    .   |           |           |                 |    .
    .   |<----------|           |                 |    .
    .   |           |           |                 |    .
    .   |           |           |~~~~~init()~~~~~>|    .
    .   |           |           |                 |    .
    .   |           |           |<----------------|    .
    .   |           |           |                 |    .
    .   |           |<~~init()~~|                 |    .
    .   |           |           |                 |    .
    .   |           |---------->|                 |    .
    .   |           |           |                 |    .
    .   |~~010101010101010101010101010101010101~~>|    .
    .   |           |           |                 |    .
    .   |<----------------------------------------|    .
    .   |           |           |                 |    .
    . +---+       +---+      +-----+           +-----+ .
    . | f |       | b |      | foo |           | bar | .
    . +---+       +---+      +-----+           +-----+ .
    .                                                  .
    ....................................................
    ''')


def test_asciisequence_condition():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        if: Yes
          f -> b
        if: Ok
          b -> c
            c -> d
              d -> c
        else:
          b -> e
        else:
          b -> d

    '''))
    assert eqdia(str(r.render()), '''
    .................................
    . DIAGRAM: Foo                  .
    . version: 1.0                  .
    .                               .
    . +---+ +---+ +---+ +---+ +---+ .
    . | f | | b | | c | | d | | e | .
    . +---+ +---+ +---+ +---+ +---+ .
    .   |     |     |     |     |   .
    . ***********   |     |     |   .
    . * if Yes  *   |     |     |   .
    . ***********   |     |     |   .
    .   |     |     |     |     |   .
    .   |~~~~>|     |     |     |   .
    .   |     |     |     |     |   .
    .   |<----|     |     |     |   .
    .   |     |     |     |     |   .
    . ***********   |     |     |   .
    . * end if  *   |     |     |   .
    . ***********   |     |     |   .
    .   |     |     |     |     |   .
    .   |   *********************** .
    .   |   * if Ok               * .
    .   |   *********************** .
    .   |     |     |     |     |   .
    .   |     |~~~~>|     |     |   .
    .   |     |     |~~~~>|     |   .
    .   |     |     |     |     |   .
    .   |     |     |<~~~~|     |   .
    .   |     |     |     |     |   .
    .   |     |     |---->|     |   .
    .   |     |     |     |     |   .
    .   |     |     |<----|     |   .
    .   |     |<----|     |     |   .
    .   |     |     |     |     |   .
    .   |   *********************** .
    .   |   * else                * .
    .   |   *********************** .
    .   |     |     |     |     |   .
    .   |     |~~~~~~~~~~~~~~~~>|   .
    .   |     |     |     |     |   .
    .   |     |<----------------|   .
    .   |     |     |     |     |   .
    .   |   *********************** .
    .   |   * else                * .
    .   |   *********************** .
    .   |     |     |     |     |   .
    .   |     |~~~~~~~~~~>|     |   .
    .   |     |     |     |     |   .
    .   |     |<----------|     |   .
    .   |     |     |     |     |   .
    .   |   *********************** .
    .   |   * end if              * .
    .   |   *********************** .
    .   |     |     |     |     |   .
    . +---+ +---+ +---+ +---+ +---+ .
    . | f | | b | | c | | d | | e | .
    . +---+ +---+ +---+ +---+ +---+ .
    .                               .
    .................................
    ''')


def test_asciisequence_conditiontext():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        s -> f
        if: 01234
          f -> b
        elif: 4545
          f -> c
            c -> s
        else: foo bar baz qux
          c -> b: foo bar
    '''))
    assert eqdia(str(r.render()), '''
    ...................................
    . DIAGRAM: Foo                    .
    . version: 1.0                    .
    .                                 .
    . +---+ +---+  +---+        +---+ .
    . | s | | f |  | b |        | c | .
    . +---+ +---+  +---+        +---+ .
    .   |     |      |            |   .
    .   |~~~~>|      |            |   .
    .   |     |      |            |   .
    .   |<----|      |            |   .
    .   |     |      |            |   .
    . ******************************* .
    . * if 01234                    * .
    . ******************************* .
    .   |     |      |            |   .
    .   |     |~~~~~>|            |   .
    .   |     |      |            |   .
    .   |     |<-----|            |   .
    .   |     |      |            |   .
    . ******************************* .
    . * elif 4545                   * .
    . ******************************* .
    .   |     |      |            |   .
    .   |     |~~~~~~~~~~~~~~~~~~>|   .
    .   |     |      |            |   .
    .   |<~~~~~~~~~~~~~~~~~~~~~~~~|   .
    .   |     |      |            |   .
    .   |------------------------>|   .
    .   |     |      |            |   .
    .   |     |<------------------|   .
    .   |     |      |            |   .
    . ******************************* .
    . * else foo bar baz qux        * .
    . ******************************* .
    .   |     |      |            |   .
    .   |     |      |<~~foo bar~~|   .
    .   |     |      |            |   .
    .   |     |      |----------->|   .
    .   |     |      |            |   .
    . ******************************* .
    . * end if                      * .
    . ******************************* .
    .   |     |      |            |   .
    . +---+ +---+  +---+        +---+ .
    . | s | | f |  | b |        | c | .
    . +---+ +---+  +---+        +---+ .
    .                                 .
    ...................................
    ''')


def test_asciisequence_emptyif():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        if
        else
    '''))
    assert eqdia(str(r.render()), '''
    ................
    . DIAGRAM: Foo .
    . version: 1.0 .
    .              .
    . **********   .
    . * if     *   .
    . **********   .
    . **********   .
    . * else   *   .
    . **********   .
    . **********   .
    . * end if *   .
    . **********   .
    .              .
    ................
    ''')


def test_asciisequence_condition_on_reversecall():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        a -> b
        if
          b -> a
    '''))
    assert eqdia(str(r.render()), '''
    ................
    . DIAGRAM: Foo .
    . version: 1.0 .
    .              .
    . +---+ +---+  .
    . | a | | b |  .
    . +---+ +---+  .
    .   |     |    .
    .   |~~~~>|    .
    .   |     |    .
    .   |<----|    .
    .   |     |    .
    . ***********  .
    . * if      *  .
    . ***********  .
    .   |     |    .
    .   |<~~~~|    .
    .   |     |    .
    .   |---->|    .
    .   |     |    .
    . ***********  .
    . * end if  *  .
    . ***********  .
    .   |     |    .
    . +---+ +---+  .
    . | a | | b |  .
    . +---+ +---+  .
    .              .
    ................
    ''')


# noqa
"""
    ................................................................
    .                                                              .
    . DIAGRAM: Foo                                                 .
    . author: alice                                                .
    . version: 1.0                                                 .
    .                                                              .
    . SEQUENCE: Title                                              .
    .                                                              .
    .      +-----+            +-------+               +-----+      .
    .      | foo |            | thud  |               | bar |      .
    .      +-----+            +-------+               +-----+      .
    .         |                   |                      |         .
    .    +----------------------------------------------------+    .
    .    | @foo ~ bar: |                                      |    .
    .    | Multiline note first line.                         |    .
    .    | Second line.                                       |    .
    .    +----------------------------------------------------+    .
    .         |                   |                      |         .
    .    +------------+           |                      |         .
    .    | @foo: note |           |                      |         .
    .    +------------+           |                      |         .
    .         |                   |                      |         .
    .         |              +--------------------------------+    .
    .         |              | @thud ~ bar: note              |    .
    .         |              +--------------------------------+    .
    .         |                   |                      |         .
    .    +----------------------------------------------------+    .
    .    | if: thud is awake                                  |    .
    .    +----------------------------------------------------+    .
    .         |                   |                      |         .
    .         |~~~~~~~~~~init()~~>|                      |         .
    .         |                   |                      |         .
    .         |              +--------------------------------+    .
    .         |              | for: i in range(5)             |    .
    .         |              +--------------------------------+    .
    .         |                   |                      |         .
    .         |                   |~~~~~~~~~~~~~fork()~~>|         .
    .         |                   |                      |         .
    .         |                   |<---------------------|         .
    .         |                   |                      |         .
    .         |              +--------------------------------+    .
    .         |              | end for                        |    .
    .         |              +--------------------------------+    .
    .         |                   |                      |         .
    .         |                   |~~~~~~~~~~~~~init()~~>|         .
    .         |                   |                      |         .
    .         |                   |<---------------------|         .
    .         |<------------------|                      |         .
    .         |                   |                      |         .
    .    +----------------------------------------------------+    .
    .    | else:                                              |    .
    .    +----------------------------------------------------+    .
    .         |                   |                      |         .
    .         |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~init()~~>|         .
    .         |                   |                      |         .
    .         |<-----------------------------------------|         .
    .         |                   |                      |         .
    .    +----------------------------------------------------+    .
    .    | end if                                             |    .
    .    +----------------------------------------------------+    .
    .         |                   |                      |              .
    .         |~~~~~~~~deinit()~~>|                      |              .
    .         |                   |~~~~~~~~~~~~~init()~~>|              .
    .         |                   |                      |              .
    .         |                   |<---------------------|              .
    .         |<------------------|                      |              .
    .         |                   |                      |              .
    .      +-----+            +-------+               +-----+           .
    .      | foo |            | thud  |               | bar |           .
    .      +-----+            +-------+               +-----+           .
    .                                                                   .
    .....................................................................

"""
