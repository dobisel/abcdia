from dial.ascii import ASCIIDiagramRenderer
from dial.diagram import Diagram

from .helpers import eqdia


def test_asciisequence_callstack():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        foo.title: Foo
        foo -> bar
          bar -> thud
            thud -> qux
              qux -> quux
        foo -> qux
        foo -> quux
          quux -> qux
    '''))
    assert eqdia(str(r.render()), '''
    ...............................................
    . DIAGRAM: Foo                                .
    . version: 1.0                                .
    .                                             .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    . | Foo | | bar | | thud  | | qux | | quux  | .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    .    |       |        |        |        |     .
    .    |~~~~~~>|        |        |        |     .
    .    |       |~~~~~~~>|        |        |     .
    .    |       |        |~~~~~~~>|        |     .
    .    |       |        |        |~~~~~~~>|     .
    .    |       |        |        |        |     .
    .    |       |        |        |<-------|     .
    .    |       |        |<-------|        |     .
    .    |       |<-------|        |        |     .
    .    |<------|        |        |        |     .
    .    |       |        |        |        |     .
    .    |~~~~~~~~~~~~~~~~~~~~~~~~>|        |     .
    .    |       |        |        |        |     .
    .    |<------------------------|        |     .
    .    |       |        |        |        |     .
    .    |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~>|     .
    .    |       |        |        |        |     .
    .    |       |        |        |<~~~~~~~|     .
    .    |       |        |        |        |     .
    .    |       |        |        |------->|     .
    .    |       |        |        |        |     .
    .    |<---------------------------------|     .
    .    |       |        |        |        |     .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    . | Foo | | bar | | thud  | | qux | | quux  | .
    . +-----+ +-----+ +-------+ +-----+ +-------+ .
    .                                             .
    ...............................................
    ''')


def test_asciisequence_call_notext():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b
        foo -> bar
        foo -> b
        f -> bar
    '''))
    assert eqdia(str(r.render()), '''
    ...............................
    . DIAGRAM: Foo                .
    . version: 1.0                .
    .                             .
    . +---+ +---+ +-----+ +-----+ .
    . | f | | b | | foo | | bar | .
    . +---+ +---+ +-----+ +-----+ .
    .   |     |      |       |    .
    .   |~~~~>|      |       |    .
    .   |     |      |       |    .
    .   |<----|      |       |    .
    .   |     |      |       |    .
    .   |     |      |~~~~~~>|    .
    .   |     |      |       |    .
    .   |     |      |<------|    .
    .   |     |      |       |    .
    .   |     |<~~~~~|       |    .
    .   |     |      |       |    .
    .   |     |----->|       |    .
    .   |     |      |       |    .
    .   |~~~~~~~~~~~~~~~~~~~>|    .
    .   |     |      |       |    .
    .   |<-------------------|    .
    .   |     |      |       |    .
    . +---+ +---+ +-----+ +-----+ .
    . | f | | b | | foo | | bar | .
    . +---+ +---+ +-----+ +-----+ .
    .                             .
    ...............................
    ''')


def test_asciisequence_calltext_minimum():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b: 1
        foo -> bar: 2
        foo -> b: 3
        f -> bar: 4
    '''))
    assert eqdia(str(r.render()), '''
    ................................
    . DIAGRAM: Foo                 .
    . version: 1.0                 .
    .                              .
    . +---+  +---+ +-----+ +-----+ .
    . | f |  | b | | foo | | bar | .
    . +---+  +---+ +-----+ +-----+ .
    .   |      |      |       |    .
    .   |~~1~~>|      |       |    .
    .   |      |      |       |    .
    .   |<-----|      |       |    .
    .   |      |      |       |    .
    .   |      |      |~~~2~~>|    .
    .   |      |      |       |    .
    .   |      |      |<------|    .
    .   |      |      |       |    .
    .   |      |<~~3~~|       |    .
    .   |      |      |       |    .
    .   |      |----->|       |    .
    .   |      |      |       |    .
    .   |~~~~~~~~~~4~~~~~~~~~>|    .
    .   |      |      |       |    .
    .   |<--------------------|    .
    .   |      |      |       |    .
    . +---+  +---+ +-----+ +-----+ .
    . | f |  | b | | foo | | bar | .
    . +---+  +---+ +-----+ +-----+ .
    .                              .
    ................................
    ''')


def test_asciisequence_calltext():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        f -> b: init()
        foo -> bar: init()
        foo -> b: init()
        f -> bar: 010101010101010101010101010101010101
    '''))
    assert eqdia(str(r.render()), '''
    ....................................................
    . DIAGRAM: Foo                                     .
    . version: 1.0                                     .
    .                                                  .
    . +---+       +---+      +-----+           +-----+ .
    . | f |       | b |      | foo |           | bar | .
    . +---+       +---+      +-----+           +-----+ .
    .   |           |           |                 |    .
    .   |~~init()~~>|           |                 |    .
    .   |           |           |                 |    .
    .   |<----------|           |                 |    .
    .   |           |           |                 |    .
    .   |           |           |~~~~~init()~~~~~>|    .
    .   |           |           |                 |    .
    .   |           |           |<----------------|    .
    .   |           |           |                 |    .
    .   |           |<~~init()~~|                 |    .
    .   |           |           |                 |    .
    .   |           |---------->|                 |    .
    .   |           |           |                 |    .
    .   |~~010101010101010101010101010101010101~~>|    .
    .   |           |           |                 |    .
    .   |<----------------------------------------|    .
    .   |           |           |                 |    .
    . +---+       +---+      +-----+           +-----+ .
    . | f |       | b |      | foo |           | bar | .
    . +---+       +---+      +-----+           +-----+ .
    .                                                  .
    ....................................................
    ''')


def test_asciisequence_selfcall():
    r = ASCIIDiagramRenderer(Diagram('''
        diagram: Foo
        version: 1.0
        sequence:

        foo -> foo: init()
        bar -> bar:
    '''))
    assert eqdia(str(r.render()), '''
    ...........................
    . DIAGRAM: Foo            .
    . version: 1.0            .
    .                         .
    . +-----+       +-----+   .
    . | foo |       | bar |   .
    . +-----+       +-----+   .
    .    |             |      .
    .    |~~init()~~+  |      .
    .    |          |  |      .
    .    |<---------+  |      .
    .    |             |      .
    .    |             |~~~~+ .
    .    |             |    | .
    .    |             |<---+ .
    .    |             |      .
    . +-----+       +-----+   .
    . | foo |       | bar |   .
    . +-----+       +-----+   .
    .                         .
    ...........................
    ''')
